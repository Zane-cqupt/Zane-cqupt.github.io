<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="徐志的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Talk is Cheap, Show me The Code">
<meta property="og:type" content="website">
<meta property="og:title" content="徐志的博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="徐志的博客">
<meta property="og:description" content="Talk is Cheap, Show me The Code">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="徐志的博客">
<meta name="twitter:description" content="Talk is Cheap, Show me The Code">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/2/"/>


  <title> 徐志的博客 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?cb28c7b1af22910846ab0156ab0d9f01";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">徐志的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">爱编程，爱生活，不羁放纵爱自由</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/19/Android-IPC系列（一）/" itemprop="url">
                  Android-IPC系列（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-19T15:52:20+08:00" content="2016-03-19">
              2016-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/19/Android-IPC系列（一）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/19/Android-IPC系列（一）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>未经博主同意，不得转载该篇文章</strong></p>
<h1 id="前言">前言</h1><p>  IPC－进程间通信。安卓虽然是一个基于linux内核的系统，但是安卓却有自己的一套IPC机制。想要弄懂安卓的IPC机制首先要理解几个framework层的概念，安卓的序列化机制以及binder和AIDL的实现流程（其它基于binder的ipc实现方式就不再多说了～）。在写这篇博客之前反复看了几遍《安卓开发艺术探索》的第二章，以及凯子哥（csdn）的framework层的文章and与一位大神学长交流，以保证文章的可靠性。这篇文章我将以自己的语言总结对于ipc的学习成果～</p>
<p>  <strong>Demo地址</strong>:<a href="https://github.com/Zane96/IPC-demo" target="_blank" rel="external">IPC-demo</a></p>
<h2 id="几个概念">几个概念</h2><p>1.<strong>Binder</strong>:</p>
<p>  Binder是安卓的一个类，实现了Binder接口（后面多次出现）。Binder我理解成安卓IPC机制的核心，也就是实现IPC的核心工具。它不仅用于安卓开发层还用于安卓的framework层。在架构层里面binder是各种系统manager之间连接的工具（WindowManager, ActivityManager等等）。开发层用于service，别告诉我你不知道service里面会返回一个IBinder。</p>
<p>2.<strong>AIDL</strong>:</p>
<blockquote>
<p>前不久在一个安卓群看到有个面试官问别人aidl是什么。。别人当时就蒙蔽了。。</p>
</blockquote>
<p>  AIDL(Android Interface Definition Language)，安卓接口定义语言。它是安卓实现IPC通信的一种比较重要的方式，并且底层基于binder。所以我们就讲这个啦！</p>
<p>3.<strong>linux的进程</strong>：</p>
<blockquote>
<p>这个问题我专门请教了一个学长～</p>
</blockquote>
<p>  Linux没有很严格的纯粹进程概念。一堆线程共享一块内存区域就是一个进程。当你的手机启动的时候，系统会启动一个init进程，这个应该可以成为Linux的主进程了。之后的所有进程都是从init进程fork出来的，比如zygote进程和SystemServer进程。</p>
<p>4.<strong>zygote进程</strong></p>
<p>  顾名思义（受精卵），这个进程会像个受精卵一样不停的“分裂”，去fork出别的进程。几乎后面出现的所有进程都是从这个进程fork出来的。包括SystemServer进程，ActivityManagerService等等。但是具体来说，AMS是SystemServer里面fork出来的。也许你会问为什么要这样做，那是因为这样设计更高效（当然我只是个普通的开发者，并不懂那些大神是怎么想的哈哈）。</p>
<p>4.<strong>ActivityManagerService</strong>:</p>
<p>  这个玩意，我觉得是相当重要的，为什么这么说呢，因为它管理着手机中<strong>所有</strong>Activity的生死。你说重不重要？？？当你打开一个app后，AMS会立马在zygote里面fork一个进程出来，并且复制一个虚拟机（Dalvik or ART）和一些资源以及一个线程（是的，这就是UI线程～，不要怀疑自己！）。启动一个app是AMS和Lanucher, ActivityThread一起合作做到的。具体的实现，自己可以去看看别的文章，这不是我们要讲的重点。另外说一点，AMS, activity之间也是通过binder来进行通信，你要知道，AMS, zygote, activity都是在不同的进程里面。</p>
<p>5.<strong>App与进程</strong>:</p>
<p>  一个app对应一个进程。这种说法我不太敢苟同。首先一个app，一个进程这种说法太模糊，因为app是可以设置多进程的哇。。（设置组件的process），所以我觉得多进程的app应该看成共享apk资源的多个应用。</p>
<p>6.<strong>ShareUID</strong>:</p>
<blockquote>
<p>之前在一个群里面听前辈们讨论app资源共享的问题，多次看到这个单词，当时在想，卧槽，这tm什么鬼？！</p>
</blockquote>
<p>  这个东西你可以大概理解成每个apk的ID。一个apk对应一个uid，所以一个app里面跑在同一个进程里面的组件数据可以共享。如果一个app里面某个组件让他跑在别的进程里面，相当于是创建了一个新的application，这个组件跟自己app里面的其它组件并没有多大关系。然后ipc就可以起作用了，通过binder进行进程间通信。如果两个属于不同app的组件，自然是有不同的application和虚拟机了，然后通过签名文件和uid来进行数据共享。普通的资源文件比如string, color这些文件是不需要相同的uid就可以访问的，但是data里面的数据是需要这样的。具体怎么做，自己有兴趣也可以去查查资料～</p>
<p>7.<strong>序列化与反序列化</strong>:</p>
<p>  首先你要知道，数据的传输都是要把数据转换成字节码，不管你是什么类型的数据。（嗯，没有例外！）序列化就是把数据转换成字节码的过程，而反序列化自然就是在数据传输的目的地把字节码转换成原始数据。之前自己为了方便，所有都使用Serializable来做序列化。后来知道Parcelable的效率更高。因为Serializable要做大量的IO操作。所以以后都要使用安卓里面的Parcelable来做序列化哦～</p>
<blockquote>
<p>好了，基本的概念介绍完毕。！如果我有说的不合理的地方请大家无情给我指出！！啪啪的打我的脸</p>
</blockquote>
<hr>
<h2 id="Binder的工作原理">Binder的工作原理</h2><blockquote>
<p>我们直接通过aidl文件生成的源码来理解binder的工作原理！</p>
</blockquote>
<p>  首先新建一个aidl的文件包。声明三个aidl文件。并且在java包里面声明我们要传输的类Book。</p>
<p><img src="/img/ipc1.png" alt="结构图"></p>
<p>  代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 16/3/16.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bookId;</span><br><span class="line">    <span class="keyword">public</span> String bookName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(<span class="keyword">int</span> bookId, String bookName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookId = bookId;</span><br><span class="line">        <span class="keyword">this</span>.bookName = bookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        dest.writeInt(bookId);</span><br><span class="line">        dest.writeString(bookName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Book&gt; CREATOR = <span class="keyword">new</span> Parcelable.Creator&lt;Book&gt;()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Book <span class="title">createFromParcel</span><span class="params">(Parcel in)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Book(in);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Book[] newArray(<span class="keyword">int</span> size)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Book[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Book</span><span class="params">(Parcel in)</span></span>&#123;</span><br><span class="line">        bookId = in.readInt();</span><br><span class="line">        bookName = in.readString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"bookId "</span> + bookId +<span class="string">" bookName "</span> + bookName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Book.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.example.zane.ipc_test;</span><br><span class="line">parcelable Book;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// IBookManager.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.example.zane.ipc_test;</span><br><span class="line"><span class="keyword">import</span> com.example.zane.ipc_test.Book;</span><br><span class="line"><span class="keyword">import</span> com.example.zane.ipc_test.IOnNewBookArrivedListener;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addBook</span><span class="params">(in Book book)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(IOnNewBookArrivedListener listener)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unRegisterListener</span><span class="params">(IOnNewBookArrivedListener listener)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// IOnNewBookArrivedListener.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.example.zane.ipc_test;</span><br><span class="line"><span class="comment">//监听服务端是否有新书籍，如果有新书籍就立即推送到客户端,观察者模式</span></span><br><span class="line"><span class="keyword">import</span> com.example.zane.ipc_test.Book;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IOnNewBookArrivedListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">newBookArrived</span><span class="params">(in Book book)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  好了，咱先不管IOnNewBookArrivedListener.aidl这个文件。我们分析IBookManager.aidl的生成源码。项目包里面的gen目录下面有一个xxx.aidl包里面会有一个IBookManager.java的文件。我们就是要分析它！嗯，搞掂它！</p>
<p>  当我用sublime打开它之后，老子差点吐掉。。</p>
<p><img src="/img/ipc2.png" alt="迷之代码"></p>
<p>  。。然后我凭借我的强迫症一个个的给它缩进！我就是这么雷锋。。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * This file is auto-generated.  DO NOT MODIFY.</span><br><span class="line"> * Original file: /Users/Zane/编程/AndroidStudioProjects 13-52-23-071/IPC_Test/app/src/main/aidl/com/example/zane/ipc_test/IBookManager.aidl</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">package</span> com.example.zane.ipc_test;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="comment">/** Local-side IPC implementation stub class. */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">zane</span>.<span class="title">ipc_test</span>.<span class="title">IBookManager</span></span><br><span class="line">  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//binder的唯一标识符</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.example.zane.ipc_test.IBookManager"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Construct the stub at attach it to the interface. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Cast an IBinder object into an com.example.zane.ipc_test.IBookManager interface,</span><br><span class="line"> * generating a proxy if needed.</span><br><span class="line"> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> com.example.zane.ipc_test.<span class="function">IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ((obj==<span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">      <span class="keyword">if</span> (((iin!=<span class="keyword">null</span>)&amp;&amp;(iin <span class="keyword">instanceof</span> com.example.zane.ipc_test.IBookManager))) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((com.example.zane.ipc_test.IBookManager)iin);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> com.example.zane.ipc_test.IBookManager.Stub.Proxy(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (code)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">          reply.writeString(DESCRIPTOR);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRANSACTION_getBookList:</span><br><span class="line">        &#123;</span><br><span class="line">          data.enforceInterface(DESCRIPTOR);</span><br><span class="line">          java.util.List&lt;com.example.zane.ipc_test.Book&gt; _result = <span class="keyword">this</span>.getBookList();</span><br><span class="line">          reply.writeNoException();</span><br><span class="line">          reply.writeTypedList(_result);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRANSACTION_addBook:</span><br><span class="line">        &#123;</span><br><span class="line">          data.enforceInterface(DESCRIPTOR);</span><br><span class="line">          com.example.zane.ipc_test.Book _arg0;</span><br><span class="line">          <span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">            _arg0 = com.example.zane.ipc_test.Book.CREATOR.createFromParcel(data);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            _arg0 = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.addBook(_arg0);</span><br><span class="line">          reply.writeNoException();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">zane</span>.<span class="title">ipc_test</span>.<span class="title">IBookManager</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line">    Proxy(android.os.IBinder remote)</span><br><span class="line">    &#123;</span><br><span class="line">      mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> java.util.List&lt;com.example.zane.ipc_test.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException</span><br><span class="line">    &#123;</span><br><span class="line">      android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">      android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">      java.util.List&lt;com.example.zane.ipc_test.Book&gt; _result;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        mRemote.transact(Stub.TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">        _result = _reply.createTypedArrayList(com.example.zane.ipc_test.Book.CREATOR);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.example.zane.ipc_test.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException</span><br><span class="line">    </span>&#123;</span><br><span class="line">      android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">      android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">if</span> ((book!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">          _data.writeInt(<span class="number">1</span>);</span><br><span class="line">          book.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          _data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">          mRemote.transact(Stub.TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</span><br><span class="line">          _reply.readException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getBookList = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addBook = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">public</span> java.util.List&lt;com.example.zane.ipc_test.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.example.zane.ipc_test.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  如果，你是第一次接触这个，或者以前没看过什么源码，内心应该跟我之前一样，也是崩溃的。但是，我们是程序员，在源码面前千万不能低头！大概看一遍，Proxy这个类看到没，嗯，没错了，用到了代理。再看Stub这个这个内部类，继承了什么？大声告诉我！嗯，就是Binder类。没错，这个Stub就是后面多次用到的Binder！其实这么多代码，只需要理解Stub, Proxy这两个类就差不多了。我们来细看代码：</p>
<p>asInterface(Binder obj):</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> com.example.zane.ipc_test.<span class="function">IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((obj==<span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//查询本地的binder</span></span><br><span class="line">      android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (((iin!=<span class="keyword">null</span>)&amp;&amp;(iin <span class="keyword">instanceof</span> com.example.zane.ipc_test.IBookManager))) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((com.example.zane.ipc_test.IBookManager)iin);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> com.example.zane.ipc_test.IBookManager.Stub.Proxy(obj);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>  这个方法在后面使用的部分会多次用到。作用就是将服务端的Binder对象转换成客户端所需要的AIDL接口类型的对象。<strong>不知道你有没有感受到，这其实就是一种类似接口回调的过程。在客户端使用这个方法去得到服务端的binder类型的接口，然后调用服务端的方法。</strong></p>
<p>  代码很简单，如果客户端和服务端在一个进程那么就返回这个binder，如果是多进程就返回远程代理类Proxy的实例。</p>
<blockquote>
<p>写到这里，突然感冒加重有点发烧的感觉。。。orz，我还是坚持下去！</p>
</blockquote>
<p>  我们再来看Proxy类里面的两个实现了IBookManager接口的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> java.util.List&lt;com.example.zane.ipc_test.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException</span><br><span class="line">    &#123;</span><br><span class="line">      android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">      android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">      java.util.List&lt;com.example.zane.ipc_test.Book&gt; _result;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        <span class="comment">//调用onTransact()方法</span></span><br><span class="line">        mRemote.transact(Stub.TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//读取异常</span></span><br><span class="line">        _reply.readException();</span><br><span class="line">        <span class="comment">//获得返回值并返回给客户端</span></span><br><span class="line">        _result = _reply.createTypedArrayList(com.example.zane.ipc_test.Book.CREATOR);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>  data是输入对象，reply是输出对象，result是最后返回给客户端的数据。这个是getBookList的方法，没有参数，只有返回值，所以data写入token标识符之后就直接调用了Stub类里面的onTransact()方法。在onTransact()方法里面把结果值写入reply并且返回true表示客户端与服务端连接成功。如果返回false就表示连接失败！再看addBook(Book book)的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.example.zane.ipc_test.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException</span><br><span class="line">    </span>&#123;</span><br><span class="line">      android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">      android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        <span class="comment">//防止传入的参数为null</span></span><br><span class="line">        <span class="keyword">if</span> ((book!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">          _data.writeInt(<span class="number">1</span>);</span><br><span class="line">          book.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          _data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//调用onTransact()方法</span></span><br><span class="line">          mRemote.transact(Stub.TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</span><br><span class="line">          _reply.readException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  我想如果你不是特别傻，应该可以类比上面看得懂这个吧！我在上面写了一些注释。然后就来看Stub是来如何响应RPC（远程过程调用）的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span><br><span class="line">    </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (code)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">          reply.writeString(DESCRIPTOR);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRANSACTION_getBookList:</span><br><span class="line">        &#123;</span><br><span class="line">          data.enforceInterface(DESCRIPTOR);</span><br><span class="line">          java.util.List&lt;com.example.zane.ipc_test.Book&gt; _result = <span class="keyword">this</span>.getBookList();</span><br><span class="line">          reply.writeNoException();</span><br><span class="line">          reply.writeTypedList(_result);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> TRANSACTION_addBook:</span><br><span class="line">        &#123;</span><br><span class="line">          data.enforceInterface(DESCRIPTOR);</span><br><span class="line">          com.example.zane.ipc_test.Book _arg0;</span><br><span class="line">          <span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">            _arg0 = com.example.zane.ipc_test.Book.CREATOR.createFromParcel(data);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            _arg0 = <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.addBook(_arg0);</span><br><span class="line">          reply.writeNoException();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  这个方法通过传进来的不同code来响应客户端不同的请求。</p>
<ol>
<li><p>TRANSACTION_getBookList里面，首先调用获得服务端的List，然后写入reply。返回true表示连接成功，并且让客户端从reply里面read出来返回过来的数据。</p>
</li>
<li><p>TRANSACTION_addBook里面，通过Parcelable去new出了一个新的Book实例。然后调用服务端的addBook方法，把这个实例返回给服务端。你如果第一次使用Parceable可能会不理解怎么new出新的Book的。你回头去看看你的Book类你就懂了！</p>
</li>
</ol>
<p>嗯！就是这么简单！源码我们基本就分析完了！我们再来总结一下流程。</p>
<ol>
<li>客户端发出请求，然后将客户端发送请求的线程挂起（这个下篇文章再说）</li>
<li>Binder写入参数（从客户端传入）到data，如果没有则不写入。</li>
<li>调用transact()方法</li>
<li>onTransact()响应，调用Service(服务端)的实现方法，并且把客户端需要的数据写入reply，如果没有则不写入。</li>
<li>result读出数据返回客户端，唤醒客户端，客户端获得数据。</li>
</ol>
<hr>
<h1 id="总结">总结</h1><p>  开始准备一篇文章直接写完。。发现得需要两篇了！</p>
<p>  这篇文章我们解决了一些IPC的基本概念知识and通过aidl学习binder的工作原理。</p>
<p>  <strong>啊啊，，，突然发烧了卧槽，好难受，下篇我们接着说AIDL的使用！</strong></p>
<p><strong>未经博主同意，不得转载该篇文章</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/01/MVP中Model的进一步细化——DataManager/" itemprop="url">
                  MVP中Model的进一步细化——DataManager
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-01T20:57:31+08:00" content="2016-03-01">
              2016-03-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/01/MVP中Model的进一步细化——DataManager/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/01/MVP中Model的进一步细化——DataManager/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言">前言</h1><p>  首先上篇文章讲到的是依赖注入（dagger），然后我使用rxjava, retrofit, dagger2, mvp做了一个练手app——<a href="https://github.com/Zane96/GithubQuery" target="_blank" rel="external">githubQuery</a>，算是第一次尝试吧。再是mvp用的是我自己的一个框架<a href="https://github.com/Zane96/EasyMVP" target="_blank" rel="external">EasyMVP</a>。然后在model层我学习了一个老外的想法，抽出来了一个叫datamanager的东西，它属于model层，用于过滤和操作从model层得到的数据。主要的目的是方便dagger提供单一的数据层依赖，并且减少presenter层的代码量。这几个库都不好上手，但是我觉得多用多写就好了，我现在已经在用这套方法在做别的项目了。</p>
<h3 id="依赖注入图">依赖注入图</h3><h2 id=""><img src="/img/gtihubquery依赖注入图1.png" alt="依赖注入图"></h2><p><img src="/img/githubquery依赖注入图2.png" alt="依赖注入图2"><br>  可以看到我在ActivityComponent中的API是抛出了很多的inject方法用来注入其他所有的activity，但是这种做法适合小项目，项目大了之后，如果每个activity的依赖需求不同还是很麻烦，所以最好一个activity一个component。对照这个图看代码基本问题不大，我记得当时对于@Inject这个注解的理解不是很深刻！</p>
<p>  DataManager相当于是model所有数据源的代理层，作为ApplicaitonComponent的API暴露出来，然后作为ActivityComponent的依赖注入进去。</p>
<h4 id="@Inject()">@Inject()</h4><p>  如果@Inject标注的是构造方法。那么表明这个类的对象也是依赖注入图里面的一员，前提是这个构造函数里面的所有参数都是来自依赖注入图（@provide）。</p>
<h3 id="项目架构图">项目架构图</h3><p><img src="/img/githubquery项目架构图.png" alt="项目架构图"></p>
<p><strong>注意，我的mvp开发模式是将activity,fragment作为presenter。</strong></p>
<p>  在这里DataManager就是整个架构的核心了。因为我们使用的是rxjava+retrofit，自然要有一种流的思想。你可以这样想，一个数据流从hepler类流到datamanager，然后在这里做你所需要的变换。比如你需要把所有学生姓名的首字母大写，但是api返回的元数据是没有大写的。这样做其实就是为了给activity等presenter瘦身。我贴出我的DataManager的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 16/1/26.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GithubApiService githubApiService;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataManager</span><span class="params">(@ContextType(<span class="string">"MyApplication"</span>)</span>Context context, GithubApiService githubApiService)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.githubApiService = githubApiService;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对用户信息进行一层过滤或者操作,然后在presenter中去调用这个方法.</span></span><br><span class="line">    <span class="comment">//当然我在这里做的操作毫无意义，但是如果有需要还是会减少activity活着fragment中的代码量。</span></span><br><span class="line">    <span class="comment">//presenter只负责调用。然后获得数据而不管代码的实现</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Users&gt; <span class="title">getUserInfo</span><span class="params">(String userName)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> githubApiService.getUserInfo(userName)</span><br><span class="line">                .map(<span class="keyword">new</span> Func1&lt;Users, Users&gt;() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Users <span class="title">call</span><span class="params">(Users users)</span> </span>&#123;</span><br><span class="line">                        String name = users.getName();</span><br><span class="line">                        users.setName(name + <span class="string">" datamanager"</span>);</span><br><span class="line">                        <span class="keyword">return</span> users;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .flatMap(<span class="keyword">new</span> Func1&lt;Users, Observable&lt;Users&gt;&gt;() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Observable&lt;Users&gt; <span class="title">call</span><span class="params">(<span class="keyword">final</span> Users users)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Users&gt;() &#123;</span><br><span class="line">                            <span class="annotation">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Users&gt; subscriber)</span> </span>&#123;</span><br><span class="line">                                subscriber.onNext(users);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对库的信息进行一层过滤</span></span><br><span class="line">    <span class="keyword">public</span> Observable&lt;List&lt;Repos&gt;&gt; getReposInfo(String userName)&#123;</span><br><span class="line">        <span class="keyword">return</span> githubApiService.getReposInfo(userName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我将用户的名字后面加了一个datamanager，在这里虽然没什么意义，但是要体现datamanager的作用所在。</p>
<h3 id="不足">不足</h3><p>没有任何东西是完美的。</p>
<p>这里如果只有一个DataManager的话，那么如果数据量一大，这个类会变得非常的臃肿和复杂。</p>
<p>所有东西都是在不断尝试吧，贴出这个思想创始人的文章:<a href="https://labs.ribot.co.uk/android-application-architecture-8b6e34acda65#.3fb3ymcjc" target="_blank" rel="external">Android Application Architecture</a></p>
<p>好了，去上课了。。近代史！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/28/MVP开发框架的一次尝试——EasyMVP/" itemprop="url">
                  MVP开发框架的一次尝试——EasyMVP
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-28T19:56:51+08:00" content="2016-01-28">
              2016-01-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/28/MVP开发框架的一次尝试——EasyMVP/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/28/MVP开发框架的一次尝试——EasyMVP/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言">前言</h1><p>  用MVP模式开发安卓相信大家也应该不是很陌生了。各种各样的mvp开发模式，框架也是层出不穷。之前写过一篇<a href="http://zane96.github.io/2015/12/06/MVP%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B0%E5%B0%9D%E8%AF%95/" target="_blank" rel="external">《MVP的一种新的尝试》</a> ，然后我基于这种模式（activity作为presenters）做了一个可能问题还是很多的开发框架:<a href="https://github.com/Zane96/EasyMVP" target="_blank" rel="external">项目地址</a> 。并且根据这个框架在前几天结合rxjava,retrofit,dagger做了一个挺简单的demo app：<a href="https://github.com/Zane96/GithubQuery" target="_blank" rel="external">githubQuery</a> 。我在想做这套框架之后意外的发现一个大牛做的框架和我是一样的思想！都是借鉴了这篇文章:<a href="https://github.com/bboyfeiyu/android-tech-frontier/tree/master/androidweekly/%E4%B8%80%E7%A7%8D%E5%9C%A8android%E4%B8%AD%E5%AE%9E%E7%8E%B0MVP%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%96%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="external">《借鉴文章》</a> 。做的也是大同小异了，顺便也借鉴了不少，还借鉴了另一个学长把adapter和viewholder解耦的思想。</p>
<h2 id="传统mvp模式的不足">传统mvp模式的不足</h2><ol>
<li><p>如果把activity作为view，那么如果activity异常销毁，那么恢复数据就是个问题了。并且还必须要把presenter和view生命周期同步。如果使用bundle，这是就直接破坏了mvp的设计模式，因为这样难免会把v和m耦合在一起。而将activity作为presenter，可以很方便的使用bundle和model层的数据进行异常恢复。</p>
</li>
<li><p>context以及各种安卓系统服务，使用intent等等。</p>
</li>
<li><p>开始想用dagger进一步把v-p-m解耦，后来发现不用了，，</p>
<p>具体不足请看前言中的借鉴文章！</p>
</li>
</ol>
<h2 id="EasyMVP">EasyMVP</h2><h3 id="介绍">介绍</h3><p>   1.使用泛型来使view和presenter解耦，通过编译期间从子activity传递过来的view类型反射获得具体view类型。并且框架完成activity的视图渲染，并且提供同步activity生命周期的函数供开发者使用。</p>
<p>   2.默认使用butterknife作为view的依赖注入。</p>
<p>   3.adapter作为presenter，并且与viewholder完全解耦，viewholder归入view层。默认使用recycle view。（别再提listview了）</p>
<p>   <img src="/img/EasyMVP.png" alt="图解"></p>
<h3 id="BaseActivityPresenters">BaseActivityPresenters</h3>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivityPresenter</span>&lt;<span class="title">V</span> <span class="keyword">extends</span> <span class="title">IView</span>&gt; <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> V v;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//通过注解获得对应的view的实例</span></span><br><span class="line">            v = getRootViewClass().newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//调用view层中生成根视图的函数</span></span><br><span class="line">        v.creatView(getLayoutInflater(), <span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">//调用view层初始化控件的函数，这里默认使用butterkinfe了。</span></span><br><span class="line">        v.initView();</span><br><span class="line">      <span class="comment">//视图渲染</span></span><br><span class="line">        setContentView(v.getRootView());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//抛出跟onCreat()函数同步的函数给开发者</span></span><br><span class="line">        inCreat(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//接触绑定</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        v.removeView();</span><br><span class="line">        v = <span class="keyword">null</span>;</span><br><span class="line">        inDestory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Class&lt;V&gt; <span class="title">getRootViewClass</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">inCreat</span><span class="params">(Bundle savedInstanceState)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">inDestory</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inPause</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inRestart</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inStop</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inResume</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inStart</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        inStart();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<pre><code>我已经在代码里面添加了一些注释。<span class="keyword">*</span><span class="keyword">*</span>框架已经默认了使用butterkinfe<span class="keyword">*</span><span class="keyword">*</span>，要避免重复依赖。再来看view层的框架代码。这样做其实是可以看成是在抽出一个BaseActivity，把一些操作黑箱化。
</code></pre><h3 id="IView">IView</h3>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IView</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">creatView</span><span class="params">(LayoutInflater inflater, ViewGroup parent)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">View <span class="title">getRootView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getRootViewId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//调用butterkinfe的unbind()方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>确定了几个<span class="built_in">view</span>代理层最基本的操作。
</code></pre><h3 id="BaseViewImpl">BaseViewImpl</h3>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/18.</span><br><span class="line"> * 将view加载的过程写在抽象类，做到代码复用。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseViewImpl</span> <span class="keyword">implements</span> <span class="title">IView</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> View view;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> SparseArray&lt;View&gt; mViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//根据activity传递过来的参数和具体view类传递过来的id生成根视图。</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">creatView</span><span class="params">(LayoutInflater inflater, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> resourceId = getRootViewId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resourceId == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"rootview's id can't be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        view = inflater.inflate(resourceId, parent, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//这就是baseactivitypresenter中调用用来渲染试图的方法。</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> View <span class="title">getRootView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//由子类去重写</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getRootViewId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加注解view方式</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>, view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ButterKnife.unbind(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseListViewHolder">BaseListViewHolder</h3><p>   这个是可以和baseviewimpl对应的，是一个viewholder的抽象父类。用的同样的方法通过中间层做到view holder和adapter解耦。区别不是太大！</p>
<p>   <img src="/img/EasyMVP2.png" alt=""></p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/18.</span><br><span class="line"> * 这个中间的base层用来做到viewholder与adapter的解耦。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseListViewHolderImpl</span>&lt;<span class="title">M</span> <span class="keyword">extends</span> <span class="title">Object</span>&gt; <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListViewHolderImpl</span><span class="params">(View itemView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(itemView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成viewholder的构造方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListViewHolderImpl</span><span class="params">(ViewGroup parent, @LayoutRes <span class="keyword">int</span> res)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(LayoutInflater.from(parent.getContext()).inflate(res, parent, <span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(M data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;T extends View&gt; T $(<span class="annotation">@IdRes</span> <span class="keyword">int</span> id) &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) itemView.findViewById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>我继承了recycle <span class="keyword">view</span>的<span class="keyword">view</span> holder，并且暴露出来一个构造函数，相当于代理层的构造函数，然后函数里面调用了recycle <span class="keyword">view</span>中viewholder的构造方法，以此来生成最终的<span class="keyword">view</span> holder。

而<span class="keyword">M</span>则是recycle <span class="keyword">view</span>展示的model的数据类型。以此保证<span class="keyword">view</span> holder和adapter数据类型的一致。方便下面的操作。

setData()方法的设计有点像接口回调，在holder的子类里面实现这个函数，在adapter里面进行回调。
</code></pre><h3 id="BaseListAdapterPresenter">BaseListAdapterPresenter</h3><pre><code>我的这个框架的启蒙文章里面也说，适配器是可以作为presenter的。这个抽象类的主要任务就是调用具体holder子类的构造函数，并且传递数据给<span class="function"><span class="title">setData</span><span class="params">()</span></span>方法，形成接口回调。
</code></pre>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/18.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseListAdapterPresenter</span>&lt;<span class="title">M</span> <span class="keyword">extends</span> <span class="title">Object</span>&gt; <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">BaseListViewHolderImpl</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Context mContext;</span><br><span class="line">    <span class="keyword">protected</span> List&lt;M&gt; mDatas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListAdapterPresenter</span><span class="params">(Context mContext)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(mContext, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//根据具体adapter子类构造函数获得的数据去初始化这里的数据。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListAdapterPresenter</span><span class="params">(Context mContext, List&lt;M&gt; mDatas)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mContext = mContext;</span><br><span class="line">        <span class="keyword">this</span>.mDatas = mDatas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseListViewHolderImpl <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> OnCreatViewHolder(parent, viewType);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//给具体adapter子类去实现，在子类里面调用具体的holder构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> BaseListViewHolderImpl <span class="title">OnCreatViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> M <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDatas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mDatas.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="问题">问题</h1><p>   刚开始这样写完了之后，发现一个问题就是presenter里面难免会需要view层的控件。比如点击一个button实现页面跳转，首先跳转功能当然要写在presenter，这就是跟传统mvp不同的一点。然后我就在想如果把view的控件一个个的暴露给presenter，但是如果需求量一大后果不堪设想。。然后我就看到那个大牛的框架用一个方法解决了这个问题：</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">protected</span> <span class="keyword">final</span> SparseArray&lt;View&gt; mViews = <span class="keyword">new</span> SparseArray&lt;View&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">bindView</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        T view2 = (T) mViews.get(id);</span><br><span class="line">       <span class="keyword">if</span> (view2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">           view2 = $(id);</span><br><span class="line">           mViews.put(id, view2);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> view2;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">get</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (T) bindView(id);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">protected</span> &lt;T extends View&gt; T $(<span class="annotation">@IdRes</span> <span class="keyword">int</span> id) &#123;</span><br><span class="line">       <span class="keyword">return</span> (T) view.findViewById(id);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//暴露监听函数</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(View.OnClickListener listener, <span class="keyword">int</span>... ids)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (ids == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> id : ids) &#123;</span><br><span class="line">           get(id).setOnClickListener(listener);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<pre><code>他用了一个可变长度的数组来存储控件。首先你可以用<span class="function"><span class="title">get</span><span class="params">(int id)</span></span>方法或者$(int id)方法（建议就用<span class="function"><span class="title">get</span><span class="params">()</span></span>，因为不必重复去findview）去在presenter中获得控件，但是不到万不得已别这样做，不然就破坏了mvp的设计模式。再就是很佩服他的<span class="function"><span class="title">setOnClickListener</span><span class="params">(View.OnClickListener listener, int... ids)</span></span>方法。完美的解决了在presenter不获得控件还能完成监听这个问题。
</code></pre><hr>
<h2 id="使用">使用</h2><p>   简单demo：</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 16/1/27.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainView2</span> <span class="keyword">extends</span> <span class="title">BaseViewImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Bind</span>(R.id.button)</span><br><span class="line">    Button button;</span><br><span class="line">    <span class="annotation">@Bind</span>(R.id.edit)</span><br><span class="line">    EditText edit;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRootViewId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String test)</span></span>&#123;</span><br><span class="line">        edit.setText(test);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   这是一个view，看到了，由于框架做了butterkinfe绑定，所以直接@Bind()！然后返回自己对应的xml文件id。</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 16/1/27.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity2</span> <span class="keyword">extends</span> <span class="title">BaseActivityPresenter</span>&lt;<span class="title">MainView2</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class&lt;MainView2&gt; <span class="title">getRootViewClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MainView2.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inCreat</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        v.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                startActivity(<span class="keyword">new</span> Intent(MainActivity2.<span class="keyword">this</span>, MainActivity.class));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, R.id.button);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inDestory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   返回对应view的class，并且完成了一次点击button跳转页面。</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/20.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainListViewHolder</span> <span class="keyword">extends</span> <span class="title">BaseListViewHolderImpl</span>&lt;<span class="title">data</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    TextView mTextView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainListViewHolder</span><span class="params">(ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent, R.layout.listview_item_layout);</span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mTextView = $(R.id.item_text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(data data)</span> </span>&#123;</span><br><span class="line">        mTextView.setText(data.getDatas());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   viewholer中不能使用butterknife默认绑定，这个问题我还没想到办法怎么解决。。不过直接用$()函数也是不错的。看到重写了父类的抽象方法，而这个函数在adapter里面被回调。</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/20.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRecycleviewAdapter</span> <span class="keyword">extends</span> <span class="title">BaseListAdapterPresenter</span>&lt;<span class="title">data</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRecycleviewAdapter</span><span class="params">(Context mContext, List&lt;data&gt; datas)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(mContext, datas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseListViewHolderImpl <span class="title">OnCreatViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MainListViewHolder(parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(BaseListViewHolderImpl holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        holder.setData(getItem(position));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   调用了父类的构造函数，返回了具体holder子类。大家会发现我并没有把holder和adapter完全解耦。对，我只是把item和adapter解耦了。使item的逻辑由自己管理，并且将holder分离出来并入view层。这块是借鉴了学长一个库的经验：项目地址：<a href="https://github.com/Jude95/EasyRecyclerView" target="_blank" rel="external">EasyRecycleView</a></p>
<h1 id="总结">总结</h1><blockquote>
<p>这是我第一次去尝试写一个框架出来，并且借鉴了很多别人的思想。而且实践的次数不多，算是自己迈出的第一步吧，以后肯定会遇到越来越多的问题，但是很值得。突然发现我这么一个小小的框架都需要想很多问题，那些牛逼框架能设计出来真是不容易。</p>
</blockquote>
<p>   <strong>未经博主同意，不得转载该篇文章</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/22/DI理解以及Dagger生成代码分析/" itemprop="url">
                  DI理解以及Dagger生成代码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-22T22:34:03+08:00" content="2016-01-22">
              2016-01-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/22/DI理解以及Dagger生成代码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/22/DI理解以及Dagger生成代码分析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言">前言</h1><p>  依赖注入是我在安卓项目架构学习（dagger+mvp+retrofit+rxjava+eventbus）里面的又一大步。通过一天多的系统学习（看别人的项目源码，博客文章，自己看dagger的生成源码），差不多也可以去自己总结一下了。dagger2的用法网上太多教程了，我就不再描述了。这里我只总结依赖注入的概念，在项目架构中的作用以及部分最基础的生成源码个人分析。建议大家在学习dagger之前先去学习java注解和反射，因为dagger确实不好理解，如果有了注解基础学习起来会更轻松。</p>
<p>  以前看人家大牛的项目都有个inject包，以前想当然的以为就是个注解包。。也不懂里面的component和module包是干嘛的。现在想想，也又算一种进步吧！</p>
<p>  <strong>大家可以通过我这个练手app巩固dagger的用法</strong> :<a href="https://github.com/Zane96/GithubQuery" target="_blank" rel="external">githubQuery</a></p>
<h2 id="依赖注入？（DI_and_IOC）">依赖注入？（DI and IOC）</h2><blockquote>
<p>其实依赖注入也是为了模块<strong>解耦</strong>，你会发现一切一切，不论是mvp还是dagger都是为了模块解耦。dagger和mvp结合起来还可以做到把m-v-p之间进一步解耦。所谓耦合就是两个模块联系在了一起，什么意思呢？比如一个模块A里面new了另一个模块B的对象，这时候就说两个模块耦合在了一起，如果现在B模块的构造函数做了修改，那么你还需要去修改模块A里面的代码。而我们希望的是B无论怎么修改都不会影响模块A。（联系mvp模式，无论m层怎么修改，都不会影响v层）而依赖注入可以用两种方法来解决：</p>
</blockquote>
<p>1.传递依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  B b;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(B b)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.b = b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  或者传递给 B的更高层级的抽象层（面向接口编程的思想）。</p>
<p>2.注入依赖。（如dagger di框架）</p>
<blockquote>
<p>其实这种解决办法就叫做<strong>控制反转</strong>（ioc）。<strong>把添加依赖的权利给外部，自己不去主动添加依赖关系</strong></p>
<p>好像有人分不大清楚dagger和butterknife有啥区别。。其实区别很大，butterkinfe也是通过注解来实现依赖注入，不过他做的是view的依赖注入。而dagger做的是更高层次的模块之间的依赖注入。</p>
</blockquote>
<p>  话说以前还写了一个很简单的view依赖注入框架（用的反射），我记得我以前在github上面写的是依赖注入框架，后来赶紧改成了view依赖注入框架。。</p>
<h2 id="依赖注入器？">依赖注入器？</h2><blockquote>
<p>如果说用传递依赖的话，那么如果模块A需要模块B的大量对象，或者说依赖程度很高，那么传递函数里面的依赖参数将会很多。</p>
<p>而使用注入器可以极大的减少代码量，模块之间的依赖关系也会很清晰。把注入器看作项目的一个模块(inject)专门负责把某些模块注入到他的依赖中去。当然说这些你可能还是不能体会到它的好处，多去写写，看看人家的项目代码才能慢慢体会。（比如我把所有的基础配置以及application的context全部提供在applicaion的module，然后直接把这个module注入到baseactivity或者application中去，然后其他的activity module再去继承这个application module。一行代码就去注入很多的依赖！）</p>
</blockquote>
<h2 id="Dagger2">Dagger2</h2><blockquote>
<p>dagger2就是现在一个比较火的依赖注入器框架。它使用的预编译期间生成代码完成依赖，而不是用的反射。。都知道反射对手机应用开发影响是比较大的。我学习这个框架就把它想成了一个注射器，component是针管，module是注射瓶，里面的依赖对象是注入的药水，build方法是插进患者，inject方法的调用是推动活塞。这样形象的理解还是很容易理解的！！</p>
</blockquote>
<p>  dagger需要掌握的就是component, module, scope,  provides, singleton.</p>
<p>  下面来探讨部分生成源码吧。</p>
<hr>
<blockquote>
<p>描述：我现在有两个medule,并且其中一个component依赖另一个component。代码如下</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 16/1/21.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityModule</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Provides</span></span><br><span class="line">    <span class="function">UserModel <span class="title">provideUserModel</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserModel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityModule2</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Provides</span></span><br><span class="line">    <span class="function">UserModelTwo <span class="title">provideUserModelTwo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserModelTwo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Component</span>(modules = ActivityModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ActivityComponent</span> </span>&#123;</span><br><span class="line">    <span class="comment">//void inject(Activity activity);</span></span><br><span class="line">    <span class="function">UserModel <span class="title">userModel</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Component</span>(dependencies = ActivityComponent.class, modules = ActivityModule2.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ActivityComponent2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个model/bean代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 16/1/21.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"xuzhi"</span>;</span><br><span class="line">    <span class="keyword">private</span> String age = <span class="string">"20"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(String age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModelTwo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String phone = <span class="string">"1888"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.phone = phone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在activity中的注入代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">activityComponent = DaggerActivityComponent</span><br><span class="line">                                    .builder()</span><br><span class="line">                                    .activityModule(<span class="keyword">new</span> ActivityModule())</span><br><span class="line">                                    .build();</span><br><span class="line">activityComponent2 = DaggerActivityComponent2</span><br><span class="line">                                     .builder()</span><br><span class="line">                                     .activityComponent(activityComponent)</span><br><span class="line">                                     .activityModule2(<span class="keyword">new</span> ActivityModule2())</span><br><span class="line">                                     .build();</span><br><span class="line">activityComponent2.inject(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们都知道，编译之后dagger框架会自动给我们生成以dagger+xxxcomponent为名的类。如我的代码就是生成了DaggerActivityComponent类，并且通过一系列的方法调用最终构建成功。看过生成代码的人会感觉他用的就是包装器模式！我们首先来看DaggerActivityComponent的builder()方法：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Generated</span>(<span class="string">"dagger.internal.codegen.ComponentProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerActivityComponent</span> <span class="keyword">implements</span> <span class="title">ActivityComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Provider&lt;UserModel&gt; provideUserModelProvider;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">DaggerActivityComponent</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> builder != <span class="keyword">null</span>;</span><br><span class="line">    initialize(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Builder();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  可以看到生成了一个Provider<usermodel> provideUserModelProvider;，而在这个组件所对应的模块里面我们提供了user model的对象。DaggerActivityComponent的构造器先不管。一步步来，我们看到builder()方法return了一个Builder类型的对象，往下看你就会看到Builder这个静态内部类！代码如下：</usermodel></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ActivityModule activityModule;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityComponent <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (activityModule == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.activityModule = <span class="keyword">new</span> ActivityModule();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DaggerActivityComponent(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">activityModule</span><span class="params">(ActivityModule activityModule)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (activityModule == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"activityModule"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.activityModule = activityModule;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  注入代码中，我们紧接着调用了activityModule(ActivityModule activityModule)方法。我们看到因为在ActivityComponent中我们用@component添加了ActivityModule。所以这里生成了这样一个方法来让你传递一个对象进来。之后我们调用了build()方法，这个方法里面调用了DaggerActivityComponent类的构造方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">DaggerActivityComponent</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> builder != <span class="keyword">null</span>;</span><br><span class="line">    initialize(builder);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  这里也没啥看的，继续看initialize(builder);方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.provideUserModelProvider =     ActivityModule_ProvideUserModelFactory.create(builder.activityModule);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  这里有个新类，叫做xxxxFactory，这个类很重要，点进去继续看creat方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Generated</span>(<span class="string">"dagger.internal.codegen.ComponentProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityModule_ProvideUserModelFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">UserModel</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ActivityModule module;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ActivityModule_ProvideUserModelFactory</span><span class="params">(ActivityModule module)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> module != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.module = module;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> UserModel <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserModel provided = module.provideUserModel();</span><br><span class="line">    <span class="keyword">if</span> (provided == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot return null from a non-@Nullable @Provides method"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> provided;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Factory&lt;UserModel&gt; <span class="title">create</span><span class="params">(ActivityModule module)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityModule_ProvideUserModelFactory(module);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  很简单，就是把我们的ActivityModule存在了这个类里面，并提供一个get方法，这个get方法之后会用到。</p>
<p>  DaggerActivityComponent类的代码我们就看完了，很简单，因为这个针头并没有提供inject方法哈哈，而是多重依赖给了ActivityComponent2.接下来看DaggerActivityComponent2的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Generated</span>(<span class="string">"dagger.internal.codegen.ComponentProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerActivityComponent2</span> <span class="keyword">implements</span> <span class="title">ActivityComponent2</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Provider&lt;UserModel&gt; userModelProvider;</span><br><span class="line">  <span class="keyword">private</span> Provider&lt;UserModelTwo&gt; provideUserModelTwoProvider;</span><br><span class="line">  <span class="keyword">private</span> MembersInjector&lt;MainActivity&gt; mainActivityMembersInjector;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">DaggerActivityComponent2</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> builder != <span class="keyword">null</span>;</span><br><span class="line">    initialize(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Builder();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  第一个module中的usermodel也被注入到了第二个module中！接着看Builder类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ActivityModule2 activityModule2;</span><br><span class="line">    <span class="keyword">private</span> ActivityComponent activityComponent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityComponent2 <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (activityModule2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.activityModule2 = <span class="keyword">new</span> ActivityModule2();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (activityComponent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"activityComponent must be set"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DaggerActivityComponent2(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">activityModule2</span><span class="params">(ActivityModule2 activityModule2)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (activityModule2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"activityModule2"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.activityModule2 = activityModule2;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">activityComponent</span><span class="params">(ActivityComponent activityComponent)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (activityComponent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"activityComponent"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.activityComponent = activityComponent;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  ActivityModule2 activityModule2，ActivityComponent activityComponent;都是这个类的静态变量，因为一个是依赖一个是对应的 module。然后你可以自己看看注入代码，我们确实是分别调用了activityComponent(ActivityComponent activityComponent)，activityModule2(ActivityModule2 activityModule2)之后才去调用build()；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.userModelProvider = <span class="keyword">new</span> Factory&lt;UserModel&gt;() &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> ActivityComponent activityComponent = builder.activityComponent;</span><br><span class="line">      <span class="annotation">@Override</span> <span class="function"><span class="keyword">public</span> UserModel <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserModel provided = activityComponent.userModel();</span><br><span class="line">        <span class="keyword">if</span> (provided == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot return null from a non-@Nullable component method"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> provided;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.provideUserModelTwoProvider = ActivityModule2_ProvideUserModelTwoFactory.create(builder.activityModule2);</span><br><span class="line">    <span class="keyword">this</span>.mainActivityMembersInjector = MainActivity_MembersInjector.create((MembersInjector) MembersInjectors.noOp(), userModelProvider, provideUserModelTwoProvider);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  最上面有一段代码，其用意相当于重新构建一个xxxxFactory类。你可以看到之前那个xxxFactory类是实现了Factory<xxx>接口，而这里则是用匿名内部类做到了，为什么要这么做呢，我认为是因为这个变量是继承过来的，所以不应该再去重复creat而是通过activitycomponent来调用userModel()方法来获得。然后我们就把两个成员变量都初始化了！之后再来看注入，我们点到MainActivity_MembersInjector.create((MembersInjector) MembersInjectors.noOp(), userModelProvider, provideUserModelTwoProvider);方法去看：</xxx></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Generated</span>(<span class="string">"dagger.internal.codegen.ComponentProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity_MembersInjector</span> <span class="keyword">implements</span> <span class="title">MembersInjector</span>&lt;<span class="title">MainActivity</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MembersInjector&lt;AppCompatActivity&gt; supertypeInjector;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;UserModel&gt; modelProvider;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;UserModelTwo&gt; model2Provider;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainActivity_MembersInjector</span><span class="params">(MembersInjector&lt;AppCompatActivity&gt; supertypeInjector, Provider&lt;UserModel&gt; modelProvider, Provider&lt;UserModelTwo&gt; model2Provider)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> supertypeInjector != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.supertypeInjector = supertypeInjector;</span><br><span class="line">    <span class="keyword">assert</span> modelProvider != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.modelProvider = modelProvider;</span><br><span class="line">    <span class="keyword">assert</span> model2Provider != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.model2Provider = model2Provider;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(MainActivity instance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot inject members into a null reference"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    supertypeInjector.injectMembers(instance);</span><br><span class="line">    instance.model = modelProvider.get();</span><br><span class="line">    instance.model2 = model2Provider.get();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MembersInjector&lt;MainActivity&gt; <span class="title">create</span><span class="params">(MembersInjector&lt;AppCompatActivity&gt; supertypeInjector, Provider&lt;UserModel&gt; modelProvider, Provider&lt;UserModelTwo&gt; model2Provider)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MainActivity_MembersInjector(supertypeInjector, modelProvider, model2Provider);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  很清楚了，也是一种包装器模式。我们可以类比，每一个被注入的类都会生成一个xxx_MembersInject类。看到我们把两个Factory对象都传进来了，并且调用了get方法来获得我们需要注入的依赖对象。大功告成，最后看DaggerActivityComponent2里面的最后一个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity activity)</span> </span>&#123;</span><br><span class="line">    mainActivityMembersInjector.injectMembers(activity);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  对！就是我们MainActivity里面调用的inject()方法。对应上一份源码看，懂了吧！这就是注入过程，所以我把inject()方法的调用比做活塞的推动。</p>
<hr>
<blockquote>
<p>所以看了这么多，其实就是想多了解一下dagger如何运作，我们的调用代码tmd为什么要这么写。嗯，就是这样！之前学这个也是越看越烦啦，后来慢慢的总结一下也是极好的。下面就准备开始用mvp+dagger2+rxjava+retrofit来搞点事情了。并且我还不准备用我自己的mvp框架，感觉写的太渣了，分分钟爆炸的节奏。。</p>
</blockquote>
<p><strong>未经博主同意，不得转载该篇文章</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/16/大二上学期总结/" itemprop="url">
                  大二上学期总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-16T23:38:15+08:00" content="2016-01-16">
              2016-01-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/随记/" itemprop="url" rel="index">
                    <span itemprop="name">随记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/16/大二上学期总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/16/大二上学期总结/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="写一点东西来结束大二上学期">写一点东西来结束大二上学期</h1><p>  感觉昨天还是在高考，今天就大二上结束了。岁月如梭，时不我待。</p>
<p>  刚回家一天多，想写点东西总结一下大二上学期。</p>
<h2 id="生活">生活</h2><blockquote>
<p> 程序员嘛，也不要整天张口闭口都是技术，聊聊生活也是挺好的。大二换了寝室楼栋，终于摆脱了坑爹的五栋。18栋还是挺棒的。由于18栋时4人间，所以脖子和老蒋没和我们在一起住了，我，辉儿子，薛撸撸，以及新加入我们的王叔叔住在一起了，组成了重邮319新生代F4。朕作为319之父，很幸运能和国舅和儿子们住在一起，学习生活虽然烦累，但在寝室还是总有些乐趣聊以自慰。</p>
<p>  这学期主要吃兴业苑的食堂。反正吃多了，怎么都觉得难吃，一回家妈妈就说我瘦了。在大学很难睡着晚上，莫名其妙的晚上喜欢亢奋（有时候是因为睡前还是想技术的问题）。反正学校过的当然不如家里了。</p>
<p>  其实要说生活还是很枯燥的，每天就是寝室，教室，工作室三点一线的生活，和高中也差不多了，这学期在大学每天在工作室待到晚上11点才到寝室（周末不休息），比高中回得还迟。然而枯燥却很有意义。</p>
<p>  辉儿子每天都在寝室锻炼身体，之前有去跑跑步，主要每天坐着太累了。想想确实得锻炼一下身体了，不然夏天穿衣服不好看，  下学期争取早点回寝室，洗澡锻炼两不误。</p>
<p>  直接把考试的学习方面也在这里总结一下吧，这学期学的运筹学和概率论确实在开头给我造成了不小麻烦，上课也听，但是我每天确实是没工夫记这些玩意，平时我也从来不关注我这些学科，都在搞自己的技术活，还好后来期末复习拼命弄了两周，及格应该没问题了。java考试和教学真的无力吐槽了。。对这种教育现状心累</p>
<p>  这学期没有了学生会这些，也没有去下山通宵了，毕竟这种事情大一做做就可以了，大二了，该踏实点了。这学期有一次班聚，喝白酒吐了一晚上，所以之后再也没有碰酒了，酒量也不行，以后能不碰坚决不碰，啤酒在内。</p>
</blockquote>
<h2 id="技术">技术</h2><blockquote>
<p>  这学期搬到了学校的蓝山工作室，环境确实好多了啊，挺温馨的，并且满爷凯爷也还在，也没觉得很陌生。大家一起坐着敲代码还是很happy的。工作室也有很多次技术交流会包括大四实习回来的学长学姐介绍经验和新技术。感觉，嗯，挺棒的。</p>
<p>  这学期换了个电脑，终于摆脱了windows和渣渣电脑的困扰，苹果大法好！开发效率大大提升。然后在工作室又给电脑配了一个显示屏，一个人一个办公桌，爽到嗨起哈哈。</p>
<p>  我在这学期开始了写博客，通玩github，看知乎（技术大牛太多，学习圣地！），看技术周报，写周报。</p>
<p>  这学期的我觉得时间主要分为两大块，一个是跟凯爷一起合作的一个项目（还是拿了点小奖励哈哈）一个是重学暑假学的一些东西。（自定义view，rxjava, retrofit, mvp,mvvm，view绘制,touch system，事件分发机制,handler实现原理，asynctask源码等等等等）。当然，我说的主要是安卓方面的。。暑假学一遍这些东西如果说是一次入门，这学期算是开始实践吧，写了很多的demo放在github上，博客总结。也有尝试去看看大牛写的关于安卓（系统架构）更深层次东西。mvp正在尝试去写一个开发框架，刚迈出了第一步，项目地址在我的github上，当然我参考了很多大牛的框架。mvvm这个开发模式伴随着data-banding的出现，不知道以后又会给安卓带来多大的改变，不过先做着吧，反正没害处，这也是我第一次尝试去做一个框架（当然很low）。这学期把python基础看了些，额，后来忙别的就落下进度了。这学期开始系统看看各位大牛的博客，安卓的学习当然主要是这些，还有很多琐碎的学习也记不大清楚了。</p>
<p>  确实这学期在做项目的时候会发现很多以前不曾想过的问题，暴露出来的问题也很多，安卓坑，但有时候我还是在自己坑自己，很多血的教训才是第一次受到，以后会更多。</p>
<p>  这学期根据自己的长远目标，开始进军数据结构和设计模式（一个让我觉得以前我写的代码大部分都是屎的学问）。看完了《大话数据结构》和《head first设计模式》，以及一点《深入理解jvm》和《effective java》，复习了一点《java核心技术》。数据结构我也只是看了书，准备去过一遍大学mooc的视频，主要是给我实践的机会几乎没有。安卓的话还是不急着去大量做开发，基础打好了再去做别的才是我选择的路。在请教了很多学长学姐以及我的小舅舅之后，我还是决定把oc基础的学习延后，先学js基础和web app开发框架。当然了，安卓依旧是我的主心骨了。这也算是我之后的打算了。</p>
<p>  深入学习java就准备从jvm和《effective java》开始了，已经进军jvm了,接下来是linux，java大法好，但是c草，当然还是要学的！苦逼</p>
</blockquote>
<hr>
<p><strong>始终记住和别人的差距，然后想办法弥补，大二上每天的生活很累但是很值得，大二下继续加油</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/11/《深入理解jvm》读书笔记——java虚拟机内存区域/" itemprop="url">
                  《深入理解jvm》读书笔记——java虚拟机内存区域
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-01-11T18:46:11+08:00" content="2016-01-11">
              2016-01-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/01/11/《深入理解jvm》读书笔记——java虚拟机内存区域/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/11/《深入理解jvm》读书笔记——java虚拟机内存区域/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="java的虚拟机内存区域">java的虚拟机内存区域</h1><h2 id="运行时数据区">运行时数据区</h2><p>1.方法区（method area）</p>
<p>2.堆（heap）</p>
<p>3.虚拟机栈（VM Stack）</p>
<p>4.本地方法栈（native method stack）</p>
<p>5.程序计数器（program counter register）</p>
<hr>
<h3 id="程序计数器">程序计数器</h3><blockquote>
<p>  这是运行区内存里面占的比较少的一块内存。它是用来标记当前虚拟机运行的字节码的行号。字节码解释器就是通过改变这个计数器来选取下一条字节码来执行。</p>
</blockquote>
<p><strong>线程恢复跟这个也有关系。当线程恢复之后，这个计数器标识的行号就是这个线程断开的位置记录，每一个线程独自拥有一个计数器</strong></p>
<p><strong>如果虚拟机现在执行的是java方法，那么计数器记录的是正在执行的虚拟机字节码指令位置，如果执行的是native方法，那么不记录。</strong></p>
<blockquote>
<p>本地方法：Java不是完美的，Java的不足除了体现在运行速度上要比传统的C++慢许多之外，Java无法直接访问到操作系统底层（如系统硬件等)，为此Java使用native方法来扩展Java程序的功能。　可以将native方法比作Java程序同Ｃ程序的接口，其实现步骤：</p>
</blockquote>
<p>　　１、在Java中声明native()方法，然后编译；</p>
<p>　　２、用javah产生一个.h文件；</p>
<p>　　３、写一个.cpp文件实现native导出方法，其中需要包含第二步产生的.h文件（注意其中又包含了JDK带的jni.h文件）；</p>
<p>　　４、将第三步的.cpp文件编译成动态链接库文件；</p>
<p>  ５、在Java中用System.loadLibrary()方法加载第四步产生的动态链接库文件，这个native()方法就可以在Java中被访问了。</p>
<h3 id="java虚拟机栈">java虚拟机栈</h3><blockquote>
<p>  java虚拟机栈是线程私有。用来描述java方法的执行。每个方法执行，都会在栈里面生成一个栈帧，用于存储局部变量，操作数栈，动态链接，方法出口等。</p>
</blockquote>
<p>  局部变量表：存编译期就可知的基本数据类型和对象引用（看作指针吧）。</p>
<p>  <strong>局部变量表的大小在编译期间就可以确定大小，并且在运行期间不会改变这一块内存的大小。</strong></p>
<blockquote>
<p>定义了两个异常</p>
</blockquote>
<p>1.stackoverflow:如果线程请求的栈深度大于了虚拟机的规定深度。</p>
<p>2.oom:如果虚拟机栈在动态扩展的时候，无法申请到足够的内存。</p>
<h3 id="本地方法栈">本地方法栈</h3><blockquote>
<p>  用来描述native方法的执行，与上着类似。java的本地方法我好像还是在这里第一次遇到唉。。以后再深究。这块内存同样定义了两种异常。</p>
</blockquote>
<h3 id="java堆">java堆</h3><blockquote>
<p>  这块倒是在没学习虚拟机之前就了解过。这是运行数据内存中最大的一块内存，同样也是gc重点关注的地方。这块就是用来存对象实例的。线程共享！</p>
</blockquote>
<p>  <strong>可以通过-Xmx, -Xms来控制这一块的内存大小，哈哈，终于能理解当初在windows下运行android studio为啥要加这个声明才能建立工程了</strong></p>
<p>  同样的，如果内存不够用可并且不能扩展，那么就会报oom。</p>
<h3 id="方法区">方法区</h3><blockquote>
<p>  我理解的是这一块就是来存储类信息的。包括类的静态变量，常量，编译后的代码。同样也是线程共享的。</p>
</blockquote>
<p>  <strong>在现在的虚拟机设计下，方法区不等同于永久带（我理解的是gc永远不会去回收内存的区域）</strong></p>
<h3 id="运行常量池">运行常量池</h3><blockquote>
<p>  常量池时包含在方法区的，用于存放编译期间生成的各种数据（class文件的常量池）。但是这个常量池不是静态的，是动态的，是可以在运行的时候存入新的数据。根据这个特性，String.intern()方法运用的很多。</p>
</blockquote>
<p>  <strong>简单补充：String.intern()方法，这个方法会先判断常量池里面有没有这个string的对象，如果有的话会直接返回这个对象的引用，而不会再去生成一个新的对象，所以字符串不可变这个特性也支持了这种做法，如果不存在才会去生成一个新的对象然后再返回引用。String s = “s”;和String s = new String(“s”);的区别在于第一种会直接把这个数据对象放入常量池儿第二种会像生成一个对象一样把数据对象放入java堆中。所以尽量使用第一种，并且字符串拼接也要使用StringBuilder或者StringBuffer，避免＋，因为这样每＋一次就会生成一个StringBuffer对象，造成大量的空间浪费。</strong></p>
<p>  如果这个区域的内存不够的话也会造成oom。</p>
<hr>
<h2 id="java对象的创建">java对象的创建</h2><blockquote>
<p>  对象的创建在我们程序员的眼里就是简单的new，但是这里说的是jvm内部时如何实现的。首先虚拟机遇到一个new指令之后，会去常量池里面（方法区里面的）看这个有没有这种符号引用的类类型（类信息），如果没有的话要去加载类信息，如果有的话就去java堆划出一块内存区域。</p>
<p>  接下来是对象的设置，这里要涉及对象头。对象头一般分为两块（数组对象时三块），一块用来存储对象的元信息，hash码等等一块用来确定这个对象是哪个类型的对象。数组对象会多出一块来存储大小。</p>
</blockquote>
<p>  <strong>这在虚拟机的眼里已经完成了独享的创建，但是还差对象的初始化哈，接下来就是对象的init</strong></p>
<h2 id="java对象的访问">java对象的访问</h2><blockquote>
<p>  我们都知道对象实例在java堆，引用存储在虚拟机栈。要通过引用来操作对象实例，得去访问它</p>
</blockquote>
<p>  1.句柄访问法：</p>
<p>  <strong>这种方法相当于是把对象实例和引用解耦了（解耦无处不在！），堆里面有一个对象实例有一个句柄池来指向对象实例和对象类型数据（方法区里面的类信息）的地址，然后引用时指向这个句柄池。也就是说引用通过句柄池来访问对象实例。这样做就是有解耦的好处啦！如果对象实例的地址变了，引用不用变，只需要修改句柄池的数据就好了。</strong></p>
<p>  2.直接指针法：</p>
<p>  <strong>这种方法就是直接引用指向对象实例的地址啦。这种方法访问速度更快！</strong></p>
<p>  <strong>未经博主同意，不得转载该篇文章</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/15/Context学习笔记/" itemprop="url">
                  Context学习笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-15T20:30:43+08:00" content="2015-12-15">
              2015-12-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/15/Context学习笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/15/Context学习笔记/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Context—上下文环境。">Context—上下文环境。</h1><blockquote>
<p>android代码与java代码的最大差别就是，android的组件必须通过context来创建实例。context是安卓的一个类，四大组件包括application类的最终父类都是context类。它是维持安卓各种组件能够正常工作的一个核心类。</p>
</blockquote>
<p><strong>context有两个子类一个是ContextWrapper：上下文功能封装类,ContextImpl：上下文功能的实现类。</strong></p>
<blockquote>
<p>context可以用来启动新的ativity， 弹出toast， 启动service， 发送广播， 操作数据库等等。不同的context的能力是不同的。比如弹出一个Dialog必须依赖在一个activity上面，所以必须通过activity的context才能来弹出一个Dialog。</p>
</blockquote>
<p><strong>一个application类或者他的子类对象本身就是一个context。</strong></p>
<blockquote>
<p>getApplication()；获得application对象实例。getApplicationContext();同样也是返回application实例，但是这个返回的实例作用域更大。getBaseApplication()；用于返回ContextImpl类的对象（实现类）。activity, application, service都是做了一层接口封装，所有的实现都是在ContextImpl中。</p>
</blockquote>
<p><strong>application（或者其他），ContextWrapper与ContextImpl三者实际上是有一种类适配器的设计模式联系在一起的。application是调用适配器，ContextWrapper是适配器，ContextImpl是被转换者。application调用getResource(), registerBroadcast()等等方法，实际上在适配器里面转换成了调用ContextImpl中对应的方法。application并不知道他的实现，也不用知道，做到了解耦。</strong></p>
<p>自定义application类的最佳实践：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;  </span><br><span class="line"><span class="number">2</span>.       </span><br><span class="line"><span class="number">3</span>.     <span class="keyword">private</span> <span class="keyword">static</span> MyApplication app;  </span><br><span class="line"><span class="number">4</span>.       </span><br><span class="line"><span class="number">5</span>.     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyApplication <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="number">6</span>.         <span class="keyword">return</span> app;  </span><br><span class="line"><span class="number">7</span>.     &#125;  </span><br><span class="line"><span class="number">8</span>.       </span><br><span class="line"><span class="number">9</span>.     <span class="annotation">@Override</span>  </span><br><span class="line"><span class="number">10</span>.     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="number">11</span>.         <span class="keyword">super</span>.onCreate();  </span><br><span class="line"><span class="number">12</span>.         app = <span class="keyword">this</span>;  </span><br><span class="line"><span class="number">13</span>.     &#125;  </span><br><span class="line"><span class="number">14</span>.       </span><br><span class="line"><span class="number">15</span>. &#125;</span><br></pre></td></tr></table></figure>
<p><strong>applcation本身就是一个单例了，不用再去做单例模式了。也不应该去new，因为它不是一个java类。application的实例除了不能start an activity和show a dialog其他都可以。</strong></p>
<blockquote>
<p>context造成的内存泄漏。在单例模式或者引用静态变量的时候，尽量避免用activity的context,因为静态变量的生命周期是整个应用。如果一个activity销毁了，那么他的context不能被销毁就造成了内存泄漏。所以尽量用application来代替。</p>
</blockquote>
<p><strong>未经博主同意，不得转载该篇文章</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/15/Handler/" itemprop="url">
                  Handler
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-15T19:57:16+08:00" content="2015-12-15">
              2015-12-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/15/Handler/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/15/Handler/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言">前言</h1><p>Handler是安卓内置的消息处理机制。虽然后来安卓又封装了handler推出了AsyncTask，并且现在又出了很多异步消息处理机制比如EventBus, RxJava等等。Eventbus内部都是使用了handler了的。所以我觉得学习这个还是很重要的。这篇文章是我转自一个朋友的博客,在这个基础上我做了一点补充,最后配上一张我做的图解。原文<a href="http://kermit95.github.io/2015/08/28/handler%E6%80%BB%E7%BB%93/" target="_blank" rel="external">王凯的博客</a></p>
<hr>
<h3 id="概述">概述</h3><p> Handler是android用来更新UI，处理消息的机制。</p>
<h3 id="使用线程和Handler更新UI">使用线程和Handler更新UI</h3><ul>
<li>方法一</li>
</ul>
<p> 新建handler对象，并覆写handleMessage()，在主线程中开启一个子线程，进行耗时操作（比如下载图片），得到图片之后，利用handler的sendMessage()，将图片发送给handler，在handleMessage()中进行UI的更新。发送时有两种方式，一种是’handler.sendMessage()’，一种是’message.sendToTarge()’。</p>
<ul>
<li>方法二</li>
</ul>
<p> 用view的post方法，post方法接收一个runnable对象，该方法将这个runnable对象发送至主线程执行。</p>
<h3 id="原理">原理</h3><p> 上述方法都是从非UI线程发送消息到UI线程，通知UI线程进行界面更新。</p>
<p> Android使用消息机制实现线程间的通信，线程通过Looper建立自己的消息循环，MessageQueue是FIFO的消息队列，Looper负责从MessageQueue中取出消息，并且分发到消息指定目标Handler对象。Handler对象绑定到线程的局部变量Looper，封装了发送消息和处理消息的接口。</p>
<h3 id="实现一次线程通信的流程">实现一次线程通信的流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span> (msg.what)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                        Log.i(<span class="string">"Test"</span>, <span class="string">"CustomThread recive message "</span> + (String)msg.obj);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在主线程中开启子线程，然后发送消息给目标handler。</p>
<h4 id="Looper">Looper</h4><p> 要想理解子线程中发生了什么必须先理解Looper。在Looper.prepare()中，Looper被设置成了线程的局部变量’ThreadLocal.set(new Looper(…))’，并且在Looper的构造函数里获取了当前线程和一个消息队列。可以说Looper在哪个线程，handler的handleMessage()方法就在哪个线程执行，因为handleMessage()方法是在Loop.loop()方法中执行的。</p>
<h6 id="ThreadLocal">ThreadLocal</h6><p> TreadLocal是为了解决线程安全的一个方案，与之对应的还有synchronized。但是本质区别是synchronized是为了数据共享，ThreadLocal是为了数据隔离。在android的handler机制中，TreadLocal维护了一个Looper对象，也就是说每个线程只能有各自的Looper，不可以共享。TreadLocal通过set和get方法存取维护的变量（这里是Looper）。关于ThreadLocal就说到这里。<strong>补充：多线程如果要访问共享数据的话，是需要做到同步的。共享数据是有很大风险的，比如不正当的操作导致所有的线程阻塞。而ThreadLocal则是给每个的线程提供了一个初始变量值，保证一个线程对应一个变量，这个变量称为局部变量。在线程中你是可以通过get来获得你set的局部变量的。</strong></p>
<h4 id="Handler">Handler</h4><p> Handler中获得到了<strong>线程局部变量Looper</strong>的消息队列。为什么Handler要持有消息队列呢，因为在发送消息环节，Handler对象需要将消息对象放入消息队列中。分析Handler，就必须明确Looper所属的线程，如果我们是在主线程创建Handler，那么Looper就是主线程的’MainLooper’，但是Looper的创建和loop方法的调用都在底层执行了。每个Handler获取消息队列的途径是，每个handler都和一个Looper绑定，每个Looper都持有一个消息队列，这样每个handler就可以获取一个消息队列。</p>
<p>关于Handler的构造方法：</p>
<ul>
<li>可以无参数</li>
<li>可以传入一个callback，用于截断消息向handleMessage()传入</li>
<li>可以传入一个Looper对象</li>
</ul>
<h4 id="loop()方法">loop()方法</h4><p> loop()方法用来从消息队列中取得方法。loop()方法所做的事：</p>
<ul>
<li>获取Looper，从而获得消息队列</li>
<li>从消息队列中取出消息，并通过消息对象中的”target”分发消息。（这里的target是一个Handler对象）</li>
<li>将分发后的消息回收</li>
</ul>
<h4 id="HandlerThread">HandlerThread</h4><p> 通过这个Thread可以稳定的获取Looper，可以通过’Hander handler = new Handler(handlerThread.getLooper())’的方式得到一个handler。而这个handler是和handlerthread绑定的，这样就可以在handlerthread线程处理消息。</p>
<p> 一般说来，都是在主线程建立handler对象，Looper是getMainLooper()，所以handleMessage都是在UI线程调用。handlerthread的目的就是能在非UI线程处理消息。</p>
<h4 id="总结">总结</h4><p> Looper持有：currentThread, messagequeue, threadlocal。在Looper.prepare()方法中，threadlocal存储了一个Looper对象，并通过Looper的构造方法，使这个looper对象获得了当前线程的实例(Thread.currentThread())，从而实现了looper和线程的关联(底层实现，是将looper作为threadlocal的value，然后将threadlocal的value赋值给currentThread的value)，所以可以将这个方法看作将所在线程变成循环线程(looper线程)的标识；在Looper.loop()中，通过myLooper()得到threadlocal中的looper，也就是所在线程的looper,进行消息分发。</p>
<p> Message持有：target(一个handler)，message有obtain方法，有的方法可能少用，但是大多和target有关，即message可以和某个handler进行绑定。但是大多时候我们不会改变message的target，事实上我们根本就不需要改变，在handler的sendMessage方法中，最终调用的是这个方法，将message放入自己持有messagequeue中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">  msg.target = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">    msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是把发送消息的Handler设置成了message的target(目标，就是这个msg将被这个target处理)。而常用的sendToTarget()方法必须设置target才能发送消息，如下代码会报空指针，必须先message.setTarget()。或者使用handler.send….方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Handler handler = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"hi~~"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">  setContentView(R.layout.activity_main);</span><br><span class="line">  Message message = Message.obtain();</span><br><span class="line">  message.sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> Handler持有：messagequeue, callback。在Handler的构造方法中，获得当前线程的looper的messageqeue(这也是为什么要先Looper.prepare()后new Handler()的原因，必须先要有looper才会有messagequeue)，至于callback:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">    handleCallback(msg);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    handleMessage(msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##图解：<br><img src="/img/Handler.png" alt="图解"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/06/MVP模式的一种新尝试/" itemprop="url">
                  MVP模式的一种新尝试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-06T19:54:22+08:00" content="2015-12-06">
              2015-12-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/06/MVP模式的一种新尝试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/06/MVP模式的一种新尝试/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言">前言</h1><p>  在暑假的时候学习了一遍mvp开发模式在android中的运用。那个时候学的时候确实觉得mvp模式做安卓开发特别清晰，代码模块分的特别清楚。但是在自己写demo的时候还是把自己有点绕晕了。因为mvp模式运用了大量的接口（面向接口编程）来实现view和model层的解耦。那时候甚至连设计模式都没看，所以一下子接触这种抽象的设计模式有点不适应。虽然说google的data-binding的不断完善会导致安卓上面mvvm模式越来越火，但是我觉得设计模式嘛，学习一下没有坏处，可以提升自己的理解力。这篇博客主要讲一种mvp的一种新尝试（将activity, fragment, adapter作为presenter）。</p>
<h2 id="MVP">MVP</h2><blockquote>
<p>  mvp模式与mvc模式最大的差别就是，它将view层跟model实现完全解耦。所有的数据交互都在presenter层中。view,model和presenter的交互通过接口，view和model的交互通过presenter。解耦的好处就是视图层和数据层两者互不影响，所有的逻辑都在presenter中，他作为一个中间层可以给多个view来使用。完全通过接口来解耦可以提高代码维护度。</p>
<p>  而mvc模式则是视图层可以通过control与数据层交互也可以直接跳过control和数据层直接交互。这样大多数时候会在view层里面new出model／bean的对象来。这样就把两者耦合在了一起。</p>
</blockquote>
<h3 id="传统mvp">传统mvp</h3><blockquote>
<p>  传统的mvp模式是将activity或者fragment作为view层，将所有的逻辑代码抽出到presenter（一个java类）。这是我暑假写的一个demo源码 <a href="https://github.com/Zane96/mvp-test-login" target="_blank" rel="external">传统mvp demo</a> 。</p>
</blockquote>
<p><img src="/img/mvp1.png" alt=""></p>
<blockquote>
<p>可以通过我的项目分包看出来，每一个类实现接口，通过接口来进行抽象解耦，以及数据交互。</p>
</blockquote>
<h3 id="一种新思想">一种新思想</h3><blockquote>
<p>  这个思想也是通过github上面一个翻译的文章看来的。因为activity中包含着context， intent，获得系统服务等等，如果把activity作为视图层就应该避免这些业务逻辑。所以将activity仅仅作为视图层有点发挥不出他的真正价值。所以我们考虑把activity，fragment，adapter来作为presenter处理逻辑，用java类文件来作为视图层。并且这样做了之后，我感觉代码的清晰度是有提升的。这是我写的demo源码：<a href="https://github.com/Zane96/MVPLogin" target="_blank" rel="external">新mvp demo</a> 。</p>
</blockquote>
<p><img src="/img/mvp2.png" alt=""></p>
<blockquote>
<p>  大概思路是用一个抽象类来抽出activity中必不可少的ui代码（比如setContentView()以及初始化各种控件）。然后每一个view类文件实现扩展了view层基接口的接口，这样做的目的是为了实现view和baseacitivty之间的解耦。（这个确实倒腾了很久，因为我感觉原文章的代码有问题）。之后在抽象类里面去通过presenter返回的view文件类型，用反射获得对象并进行view的渲染。然后再在presenter中去处理逻辑。看代码吧！</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/5.</span><br><span class="line"> * 用于抽出activity中对于ui的操作代码</span><br><span class="line"> * 弄出两个抽象方法来保证生命周期同步</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePresentActivity</span>&lt;<span class="title">X</span> <span class="keyword">extends</span> <span class="title">V</span>, <span class="title">V</span> <span class="keyword">extends</span> <span class="title">Vu</span>&gt; <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> V vu;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            vu = getVuClass().newInstance();</span><br><span class="line">            vu.init(getLayoutInflater(), <span class="keyword">null</span>);</span><br><span class="line">            setContentView(vu.getView());</span><br><span class="line">            onBindVu();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        onDestroyVu();</span><br><span class="line">        vu = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;X&gt; <span class="title">getVuClass</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindVu</span><span class="params">()</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroyVu</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  首先解释这个抽象类的两个泛型。Vu是view层的基接口，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/5.</span><br><span class="line"> * view类的超类</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Vu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(LayoutInflater inflater, ViewGroup container)</span></span>;</span><br><span class="line">    <span class="function">View <span class="title">getView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   可以看到有两个方法，一个用来进行view渲染，一个是返回根视图。而泛型里面的V就是扩展了Vu的第二层接口。最后X就是实现了第二层接口的view类文件。这样做的目的就是做到解耦，防止我用传入的类文件去实例化类文件，这里应该是去实例化接口。（用X的对象去实例化V）</p>
<p>  然后再看onBindVu()和onDestoryVu()方法，这个方法是在继承了这个抽象类的presenter里面去实现的，目的是为了达到生命周期同步。</p>
<p>  getVuClass()方法就是要获得这个presenter对应的view类文件类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/5.</span><br><span class="line"> * 为了使view类和present类解藕</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">VuLoginActivity</span> <span class="keyword">extends</span> <span class="title">Vu</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Button <span class="title">getButtonLogin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Button <span class="title">getButtonClear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">EditText <span class="title">getEditTextAccount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">EditText <span class="title">getEditTextPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearText</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  这就是扩展了Vu接口的第二层接口。看到我添加了几个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/12/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivityViewImpl</span> <span class="keyword">implements</span> <span class="title">VuLoginActivity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> View view;</span><br><span class="line">    <span class="keyword">protected</span> Button buttonLogin;</span><br><span class="line">    <span class="keyword">protected</span> Button buttonClear;</span><br><span class="line">    <span class="keyword">protected</span> EditText account;</span><br><span class="line">    <span class="keyword">protected</span> EditText password;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(LayoutInflater inflater, ViewGroup container)</span> </span>&#123;</span><br><span class="line">        view = inflater.inflate(R.layout.activity_main, container, <span class="keyword">false</span>);</span><br><span class="line">        buttonLogin = (Button)view.findViewById(R.id.button_login);</span><br><span class="line">        buttonClear = (Button)view.findViewById(R.id.button_clear);</span><br><span class="line">        account = (EditText)view.findViewById(R.id.account);</span><br><span class="line">        password = (EditText)view.findViewById(R.id.password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Button <span class="title">getButtonLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buttonLogin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Button <span class="title">getButtonClear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> buttonClear;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EditText <span class="title">getEditTextAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> account;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EditText <span class="title">getEditTextPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        account.setText(<span class="string">""</span>);</span><br><span class="line">        password.setText(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  这里代码也很简单啦！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BasePresentActivity</span>&lt;<span class="title">LoginActivityViewImpl</span>, <span class="title">VuLoginActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onBindVu</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> User user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">        vu.getButtonLogin().setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                String userName = vu.getEditTextAccount().getText().toString();</span><br><span class="line">                String password = vu.getEditTextPassword().getText().toString();</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, userName, Toast.LENGTH_SHORT).show();</span><br><span class="line">                <span class="keyword">if</span>(userName.equals(user.getUserName()) &amp;&amp; password.equals(user.getPassword())) &#123;</span><br><span class="line">                    Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, LoginSuccessActivity.class);</span><br><span class="line">                    intent.putExtra(<span class="string">"username"</span>, userName);</span><br><span class="line">                    startActivity(intent);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"错误"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        vu.getButtonClear().setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                vu.clearText();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroyVu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroyVu();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Class&lt;LoginActivityViewImpl&gt; <span class="title">getVuClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LoginActivityViewImpl.class;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  这个就是presenter。看到我在对应的生命周期里面做了逻辑处理，并且返回他对应的view类文件。</p>
<h1 id="结束语">结束语</h1><blockquote>
<p>  MVP模式确实给项目维护带来了一些便捷，但是也发现，相对于小的项目会导致你的代码量迅速膨胀。所有很多人弄一些mvp的开发框架。确实我自己也想用这种新思路来倒腾一个。但是对于大型项目，这样的代码膨胀并不算什么，带来的好处绝对优于坏处。这次学习又巩固了一下我的设计模式。以一句话结尾：<strong>面对接口编程， 避免面对实现编程</strong></p>
</blockquote>
<p><strong>未经博主同意，不得转载该篇文章</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/26/关于RecycleView显示异步加载图片乱序的问题/" itemprop="url">
                  关于RecycleView显示异步加载图片乱序的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-11-26T22:41:45+08:00" content="2015-11-26">
              2015-11-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/26/关于RecycleView显示异步加载图片乱序的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/26/关于RecycleView显示异步加载图片乱序的问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于RecycleView显示加载图片乱序的问题">关于RecycleView显示加载图片乱序的问题</h1><h1 id="前言">前言</h1><blockquote>
<p>本来之前都在准备touch的第二篇博客。但是突然想起之前做的一个项目中和搭档一起遇到一个问题，就是recycleview的item中的imageview显示图片错位（网络加载图片）。当然。。当时在做项目，自然就是赶紧找解决办法呗，看了官方教程和郭神的博客，但是只看他们的教程还是没有很好的解决，因为我们的东西是有些item的imageview为空，而他们讲的都是所有item的imageview都有图片。不过最后也还是稀里糊涂的解决了哈哈。昨天自己写了一个demo,放在我的github嗒。通过源码和大神们的博客想总结一下这个问题。<a href="https://github.com/Zane-cqupt/BestBitmapDownload" target="_blank" rel="external">源码地址</a></p>
</blockquote>
<h2 id="关于这个问题">关于这个问题</h2><blockquote>
<p>如果大家看过郭神的博客或者自己遇到过，就会知道解决这个问题有三种方法，第一是给imageview设置tag，第二是我用到的，给AsyncTask和imageview双向添加弱引用，进行逻辑判断。第三当然就是用第三方库啰，比如volley的图片加载或者现在最牛逼的fresco！第三方库的控件之所以能解决这个问题，其实就是自己内部做了处理。虽然提倡<strong>不要造重复的轮子</strong> ,但是得知道轮子时怎么造出来的。而我们遇到的问题（有些item的imageview为空图）连第三方库都不能解决。通过看imageview的源码，很快也解决了这个问题。那么recycleview显示异步加载图片错位的原因是什么呢？</p>
</blockquote>
<p><img src="/img/4.1.png" alt="图解"></p>
<blockquote>
<p>RecycleView和ListView一样，每个item里面的控件<strong>都是复用的</strong> ！也就是说不可能你有10k个item系统就给你提供10k个imageview，要不然系统造就gg了。所以正是这个原因也导致了我们遇到的这个坑。系统真正提供给你的imageview可能只有显示的item多一点点～</p>
</blockquote>
<p><img src="/img/4.2.png" alt=""></p>
<blockquote>
<p>从这个图你就可以清楚的知道为什么会错乱了。首先<strong>itemA处于显示状态，然后隐藏，那么他的imageview被收回到recycleBin等待下一次被利用。并且这个imageview已经跟一个drawable关联了，这个drawable就是task请求的结果，task是否在被回收之前已经完成自己的使命并不确定。接下来itemB从隐藏变成了显示状态。那么itemA的那个imageview就可能会被系统拿去给itemB使用。一旦使用就会导致图片错乱。也就是说，，一个imageview就有了两个task，两个drawble…不错乱才怪了</strong> 。</p>
</blockquote>
<h2 id="解决它！">解决它！</h2><h4 id="思路">思路</h4><blockquote>
<p>既然是因为拿到的imageview包含一个task而导致错乱，那么我们取消它不就完了。确实就是这样。</p>
</blockquote>
<ol>
<li><p>在每一个task里面放进它所对应的imageview弱引用(使系统想收回资源的时候大胆的收回)</p>
<p>将imageview通过task的构造器在适配器里面把imageview传给task。</p>
</li>
<li><p>在每一个imageview里面放入它对应的task的弱引用。</p>
<p>这个比较复杂。我需要用一个BitmapDrawable类来做桥梁。因为imageview和drawable的关联用set方法就ok了。在自定义的BitmapDrawable的子类的构造器里面我们传入默认的占位图和task引用。在子类里面进行弱引用包装。</p>
</li>
</ol>
<blockquote>
<p>双引用实现了之后，<strong>我们不管系统给我的imageview的task是否完成，都判断两个task的url是否相同。如果相同就可以不用管了，如果url都不相同还管你个屁，直接把imageview中带来的task给我取消了。哈哈，可能大家觉得这样就够了。说实话，我之前也是这么想的，可是如果只做到这一步，新显示的item还是会显示一段时间的imageview的drawable直到自己的task完成才会恢复正常。原因就是传进来的imageview的task在传进来之前就可能已经完成了。这个弯一定要绕过去！</strong>思路有了，我们开始看代码吧！</p>
<p>直接上适配器的代码了</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Zane on 15/11/25.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecycleViewAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecycleViewAdapter</span>.<span class="title">MyViewHolder</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//图片缓存LruCache</span></span><br><span class="line">    <span class="keyword">private</span> LruCache&lt;String, BitmapDrawable&gt; mLrucache;</span><br><span class="line">    <span class="keyword">private</span> LayoutInflater layoutInflater;</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecycleViewAdapter</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        layoutInflater = LayoutInflater.from(context);</span><br><span class="line">        <span class="keyword">int</span> maxSize = (<span class="keyword">int</span>) Runtime.getRuntime().maxMemory();</span><br><span class="line">        <span class="keyword">int</span> cacheSize = maxSize / <span class="number">8</span>;</span><br><span class="line">        mLrucache = <span class="keyword">new</span> LruCache&lt;String, BitmapDrawable&gt;(cacheSize)&#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, BitmapDrawable value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.getBitmap().getByteCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</span><br><span class="line">        View view = layoutInflater.inflate(R.layout.item_recycleview, parent, <span class="keyword">false</span>);</span><br><span class="line">        MyViewHolder holder = <span class="keyword">new</span> MyViewHolder(view);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我用到了Lrucache进行图片缓存。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(MyViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    String url;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//if(position != 1) &#123;</span></span><br><span class="line">        url = Images.imageUrls[position];</span><br><span class="line">        BitmapDrawable drawable = getBitmapFromMemoryCache(url);</span><br><span class="line">        <span class="keyword">if</span>(drawable != <span class="keyword">null</span>)&#123;</span><br><span class="line">            holder.imageView.setImageDrawable(drawable);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            loadBitmap(url, holder.imageView);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">//else &#123;</span></span><br><span class="line">    <span class="comment">//    holder.imageView.setImageResource(R.drawable.ic_launcher);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Images.imageUrls.length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先判断缓存里面是否有存储的图像，提高效率。可以看到我上面代码的注释，那是为了测试后面某个item的imageview为空的情况。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加imageview的弱引用</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapDownloadTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Void</span>, <span class="title">BitmapDrawable</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ImageView imageView;</span><br><span class="line">    <span class="keyword">private</span> WeakReference&lt;ImageView&gt; imageViewWeakReference;</span><br><span class="line">    <span class="keyword">public</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitmapDownloadTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.imageView = imageView;</span><br><span class="line">        imageViewWeakReference = <span class="keyword">new</span> WeakReference&lt;ImageView&gt;(imageView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BitmapDrawable <span class="title">doInBackground</span><span class="params">(String... params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        url = params[<span class="number">0</span>];</span><br><span class="line">        Bitmap bitmap = downloadBitmap(url);</span><br><span class="line">        BitmapDrawable bitmapDrawable = <span class="keyword">new</span> BitmapDrawable(context.getResources(), bitmap);</span><br><span class="line">        addBitmapToMemoryCache(url, bitmapDrawable);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bitmapDrawable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(BitmapDrawable bitmapDrawable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(isCancelled())&#123;</span><br><span class="line">            bitmapDrawable = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//第二次判断，如果iamgeview里面的task跟这个item根据适配器传进来的正确url启动的task不相同，就不显示图片</span></span><br><span class="line">        <span class="keyword">if</span>(imageViewWeakReference != <span class="keyword">null</span> &amp;&amp; bitmapDrawable != <span class="keyword">null</span>)&#123;</span><br><span class="line">            ImageView imageView = imageViewWeakReference.get();</span><br><span class="line">            BitmapDownloadTask task = getBitmapWorkerTask(imageView);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span> == task &amp;&amp; imageView != <span class="keyword">null</span>)&#123;</span><br><span class="line">                imageView.setImageDrawable(bitmapDrawable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//imageView.setImageDrawable(bitmapDrawable);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Bitmap <span class="title">downloadBitmap</span><span class="params">(String imageUrl)</span> </span>&#123;</span><br><span class="line">        Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line">        HttpURLConnection con = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(imageUrl);</span><br><span class="line">            con = (HttpURLConnection) url.openConnection();</span><br><span class="line">            con.setConnectTimeout(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">            con.setReadTimeout(<span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">            bitmap = BitmapFactory.decodeStream(con.getInputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">                con.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里面onPostExecute()方法进行的判断是我们的逻辑判断的第二步。我们取出imageview对应的task跟“正规军task”进行比较，如果为空或者不相等的话，阻止imageview设置上一次task完成之后得到的drawable。注意，这些都是在item的”正规军task”里面执行的哦，别绕昏了！</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用来根据传进来的imageview获得对应的drawable,再获得对应的task</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BitmapDownloadTask <span class="title">getBitmapWorkerTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Drawable drawable = imageView.getDrawable();</span><br><span class="line">            <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AsyncDrawable) &#123;</span><br><span class="line">                <span class="keyword">final</span> AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;</span><br><span class="line">                <span class="keyword">return</span> asyncDrawable.getBitmapTask();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这段代码就是根据imageview获得对应task的方法了。之前说到，我是把BitmapDrawable作为绑定的桥梁。所以先获得drawable然后再获得task。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加task的弱引用</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;BitmapDownloadTask&gt; taskWeakReference;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncDrawable</span><span class="params">(Resources res, Bitmap bitmap</span><br><span class="line">                                    , BitmapDownloadTask task)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(res, bitmap);</span><br><span class="line">            taskWeakReference = <span class="keyword">new</span> WeakReference&lt;BitmapDownloadTask&gt;(task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BitmapDownloadTask <span class="title">getBitmapTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> taskWeakReference.get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个就是桥梁啰。代码很简单～</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将drawable与imageview绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(String url, ImageView imageView)</span></span>&#123;</span><br><span class="line">        Bitmap mLoadingBitmap = BitmapFactory.decodeResource(context.getResources(), R.drawable.ic_launcher);</span><br><span class="line">        <span class="keyword">if</span> (cancelBeforeTask(url, imageView))&#123;</span><br><span class="line">            BitmapDownloadTask task = <span class="keyword">new</span> BitmapDownloadTask(imageView);</span><br><span class="line">            AsyncDrawable drawable = <span class="keyword">new</span> AsyncDrawable(context.getResources(), mLoadingBitmap, task);</span><br><span class="line">            <span class="comment">//!!!!</span></span><br><span class="line">            imageView.setImageDrawable(drawable);</span><br><span class="line">            task.execute(url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个方法就是用来根据适配器给我的url启动一次“正规军task”的方法了～<strong>if (cancelBeforeTask(url, imageView))</strong>这里就是我做的第一次判断。如果返回true那么就启动正规军 task.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用来进行第一步的判断，如果imageview对应的task的url跟传进去的url不同，那么取消上一次task</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancelBeforeTask</span><span class="params">(String url, ImageView imageView)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        BitmapDownloadTask task = getBitmapWorkerTask(imageView);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(task != <span class="keyword">null</span>)&#123;</span><br><span class="line">            String imgUrl = task.url;</span><br><span class="line">            <span class="keyword">if</span> (imgUrl != url || imgUrl == <span class="string">""</span>)&#123;</span><br><span class="line">                task.cancel(<span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果系统给我的imageview的task的url跟适配器给我的正规url不同，那么表示两个task启动的图片都不同，所以取消上一次的task然后返回true。</p>
</blockquote>
<h2 id="结果呢？">结果呢？</h2><p><img src="/img/4.3.png" alt="结果"></p>
<blockquote>
<p>特么的，当然是没问题的啦！可是！！！如果我现在第二个item设置为空图，就又会出现问题了！</p>
</blockquote>
<p>我改一下代码使第二张图不为空，效果如下：</p>
<p><img src="/img/4.4.png" alt=""></p>
<p>然后我滑动一下屏幕，效果如下：</p>
<p><img src="/img/4.5.png" alt=""></p>
<blockquote>
<p>卧槽。。对，这就是我们当初遇到的问题。如何解决呢？很简单，如果为空那就给它一个永久的占位图就可以了。</p>
</blockquote>
<p><img src="/img/4.6.png" alt="like this!"></p>
<h1 id="结束语">结束语</h1><blockquote>
<p>说实话有些东西不必弄的太深，分享最近的一些感想：给你一大堆材料，让你搭建一个高楼。材料如何生产质量更好，你不必太关心。材料质量怎样，你需要去关心。而如何把这栋房子搭建的更牢固，怎么搭建用料最少，复用性更高，耦合度更低，才是最需要去关心的。有时候房子的构建不好，会出现不稳固，不健壮，甚至地基不稳（内存泄露？）。实在可怕——做项目有感而发。  但是这种问题，并且是工作中遇到的问题，还是值得去探究并解决的。如何找到解决问题，也是面试官考察你的很重要的一点。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/me.jpg"
               alt="Zane Xu" />
          <p class="site-author-name" itemprop="name">Zane Xu</p>
          <p class="site-description motion-element" itemprop="description">Talk is Cheap, Show me the Code</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">24</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zane Xu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zane"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

  


</body>
</html>
